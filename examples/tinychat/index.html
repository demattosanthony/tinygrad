<!DOCTYPE html>
<html lang="en">
<head>
  <title>tinychat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />

  <!-- Alpine.js and Plugins -->
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/@marcreichel/alpine-autosize@1.3.x/dist/alpine-autosize.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Markdown Parsing and Syntax Highlighting -->
  <script src="https://unpkg.com/dompurify@3.1.5/dist/purify.min.js"></script>
  <script src="https://unpkg.com/marked@13.0.0/marked.min.js"></script>
  <script src="https://unpkg.com/marked-highlight@2.1.2/lib/index.umd.js"></script>
  <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>

  <script src="index.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Highlight.js CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/vs2015.min.css" />

  <link rel="stylesheet" href="index.css" />
</head>

<body>
  <main x-data="state">
    <div class="home centered" x-show="home === 0" x-transition x-effect="
      $refs.inputForm.focus();
      if (home === 1) setTimeout(() => home = 2, 100);
      if (home === -1) setTimeout(() => home = 0, 100);
    " @popstate.window="
      if (home === 2) {
        home = -1;
        cstate = { time: null, messages: [] };
        time_till_first = 0;
        tokens_per_second = 0;
        total_tokens = 0;
      }
    ">
      <img src="tinychat.svg" alt="tinychat logo" class="logo" />
      <button @click="showHistoryModal = true" class="see-history-button">
        Chat history
      </button>
    </div>

    <!-- History Modal -->
    <div x-show="showHistoryModal" x-transition class="modal" @click.self="showHistoryModal = false" x-cloak>
      <div class="modal-content">
        <h2>Chat History</h2>
        <div class="histories-container">
          <template x-for="_state in histories.toSorted((a, b) => b.time - a.time)">
            <div class="history" @click="
              cstate = _state;
              updateTotalTokens(cstate.messages);
              home = 1;
              showHistoryModal = false;
              window.history.pushState({}, '', '/');
            ">
              <h3 x-text="new Date(_state.time).toLocaleString()"></h3>
              <p
                x-text="_state.messages[0].content.length > 80 ? _state.messages[0].content.slice(0, 80) + '...' : _state.messages[0].content">
              </p>
              <button class="history-delete-button" @click.stop="removeHistory(_state);">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </template>
        </div>
        <button @click="showHistoryModal = false" class="close-modal-button">
          Close
        </button>
      </div>
    </div>

    <div x-ref="messages" class="messages" :class="{ empty: cstate.messages.length === 0 }">
      <div x-ref="messages" class="messages-inner" x-init="
        $watch('cstate', value => {
          $el.innerHTML = '';
          value.messages.forEach(({ role, content }) => {
            const div = document.createElement('div');
            div.className = `message message-role-${role}`;
            try {
              div.innerHTML = DOMPurify.sanitize(marked.parse(content));
            } catch (e) {
              console.log(content);
              console.error(e);
            }

            // Add clipboard button to code blocks
            const codeBlocks = div.querySelectorAll('.hljs');
            codeBlocks.forEach(codeBlock => {
              const button = document.createElement('button');
              button.className = 'clipboard-button';
              button.innerHTML = '<i class=\'fas fa-clipboard\'></i>';
              button.onclick = () => {
                const range = document.createRange();
                range.setStartBefore(codeBlock);
                range.setEndAfter(codeBlock);
                window.getSelection()?.removeAllRanges();
                window.getSelection()?.addRange(range);
                document.execCommand('copy');
                window.getSelection()?.removeAllRanges();

                button.innerHTML = '<i class=\'fas fa-check\'></i>';
                setTimeout(() => button.innerHTML = '<i class=\'fas fa-clipboard\'></i>', 1000);
              };
              codeBlock.appendChild(button);
            });

            $el.appendChild(div);
          });

          $el.scrollTo({ top: $el.scrollHeight, behavior: 'smooth' });
        });
      " x-intersect="
        $el.scrollTo({ top: $el.scrollHeight, behavior: 'smooth' });
      " x-show="home === 2" x-transition></div>
    </div>

    <div class="input-container">
      <!-- Performance stats above the input -->
      <div class="input-performance">
        <span class="input-performance-point">
          <p>Time to first token</p>
          <p class="monospace" x-text="(time_till_first / 1000).toFixed(2)"></p>
        </span>
        <span class="input-performance-point">
          <p>Tokens/s:</p>
          <p class="monospace" x-text="tokens_per_second.toFixed(1)"></p>
        </span>
        <span class="input-performance-point">
          <p>Tokens:</p>
          <p class="monospace" x-text="total_tokens"></p>
        </span>
      </div>

      <!-- Input box -->
      <div class="input">
        <textarea x-ref="inputForm" id="input-form" class="input-form" autofocus rows="1" x-autosize
          :placeholder="generating ? 'Generating...' : 'Say something'" :disabled="generating" @input="
          if (cstate.messages.length === 0 && $el.value === '') home = -1;
          if ($el.value !== '') {
            const messages = [...cstate.messages];
            messages.push({ role: 'user', content: $el.value });
            updateTotalTokens(messages);
          } else {
            if (cstate.messages.length === 0) total_tokens = 0;
            else updateTotalTokens(cstate.messages);
          }
        " x-effect="
          if (!generating) $nextTick(() => {
            $el.focus();
            setTimeout(() => $refs.messages.scrollTo({ top: $refs.messages.scrollHeight, behavior: 'smooth' }), 100);
          });
        " @keydown.enter="await handleEnter($event)" @keydown.escape.window="$focus.focus($el)"></textarea>
        <button class="input-button" :disabled="generating" @click="await handleSend()">
          <i class="fas" :class="generating ? 'fa-spinner fa-spin' : 'fa-paper-plane'"></i>
        </button>
      </div>
    </div>
  </main>
</body>
</html>